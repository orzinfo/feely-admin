# 项目优化方案 5.0

基于深度代码审计，本方案聚焦于 **并发性能阻断**、**数据库索引缺失** 以及 **代码健壮性** 问题。这些问题虽然不直接导致 crash，但在高并发下会严重拖慢系统，或在排障时掩盖真凶。

## 1. 概述
本次扫描发现了阻塞 Event Loop 的同步调用（P1）、核心字段索引缺失（P1）以及危险的静默异常捕获（P1）。

## 2. 优化点详细分析

### P1 级：高优先级改进 (High)

#### 1. 密码哈希计算阻塞 Event Loop
- **位置**: [security.py](app/utils/security.py)
- **问题描述**: 
  `passlib` 的 `hash` 和 `verify` 是 CPU 密集型操作（设计如此，防暴力破解）。
  在 `async def` 中直接调用它们会 **阻塞主线程**，导致在此期间无法处理任何其他请求（Heartbeat、DB IO 等统统暂停）。
- **优化方案**:
  使用 `asyncio.to_thread` (Python 3.9+) 或 `run_in_executor` 将其放入线程池执行，释放 Event Loop。

#### 2. 核心查询字段缺失数据库索引
- **位置**: [models/system.py](app/models/system.py) (原 admin.py)
- **问题描述**: 
  - `Menu.parent_id`: 树形结构查询最频繁的字段，无索引导致递归查询全表扫描。
  - `Button.button_code`: 权限校验高频字段，无索引。
  - `Menu.order`: 排序字段。
- **优化方案**:
  在模型字段定义中添加 `index=True`。

#### 3. 中间件中的静默异常捕获
- **位置**: [middlewares.py](app/core/middlewares.py) -> `_get_user_id_from_token`
- **问题描述**: 
  使用 `except Exception: pass` 捕获所有异常且不记录日志。
  如果 `check_token` 内部发生非预期的 `ImportError` 或 `AttributeError`，系统将“假装无事发生”，导致鉴权逻辑诡异失效且无从排查。
- **优化方案**:
  改为捕获特定异常，或者在 `except` 块中记录 `logger.warning`。

### P2 级：架构与质量 (Medium)

#### 4. 事务范围过大（包含 CPU 密集操作）
- **位置**: [user.py](app/controllers/user.py) -> `update`
- **问题描述**: 
  `@atomic()` 事务开启后，执行了耗时的 `get_password_hash`。
  这会导致数据库连接被长时间占用（等待 CPU 计算完成），降低数据库并发吞吐量。
- **优化方案**:
  将 `get_password_hash` 移到事务开启之前（即 `super().update` 之前）执行。

#### 5. 硬编码的错误码
- **位置**: [user.py](app/controllers/user.py) 等
- **问题描述**: 
  大量使用 `"4040"` 字符串作为错误码，难以统一管理和修改。
- **优化方案**:
  提取常量类 `ErrorCode`，统一管理业务错误码。
