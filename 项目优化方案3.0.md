# 项目优化方案 3.0

> 范围：仅覆盖 `app/` 后端代码（FastAPI + TortoiseORM + Redis + fastapi-cache）。
>
> 评级说明：
> - **P0（Critical）**：存在数据泄露/权限绕过/生产破坏风险，必须优先处理
> - **P1（High）**：显著影响稳定性/性能/可观测性，建议尽快处理
> - **P2（Medium）**：可维护性/一致性/工程化改进，排期处理

---

## P0（Critical）

### 1) 用户态接口被“全局缓存”，存在跨用户数据泄露风险
- **影响**：不同用户可能命中同一个缓存 key，拿到他人的 `user-info` / `user-routes` 数据（典型的“缓存穿越用户边界”）。
- **证据**
  - 缓存 key 构建只包含 `query_params`，未纳入 `path/Authorization/user_id`：[_init_cache](file:///Users/galen/Project/feely-admin/app/__init__.py#L160-L191)
  - 用户态接口启用了 `@cache`：
    - [auth.py:user-info](file:///Users/galen/Project/feely-admin/app/api/v1/auth/auth.py#L87-L118)
    - [route.py:user-routes](file:///Users/galen/Project/feely-admin/app/api/v1/route/route.py#L92-L139)
- **优化建议**
  - **立即措施（推荐）**：对所有“与用户绑定”的接口禁用共享缓存（移除 `@cache`），或只在“严格按用户隔离 key”的前提下缓存。
  - **正确缓存设计**（若必须缓存）：
    - key 至少包含：`path + user_id(或 token 指纹) + query +（必要时 body 摘要）`
    - 避免使用 Python 内置 `hash()`（进程级随机盐、重启后 key 不稳定，且存在碰撞风险）
  - **回归测试建议**：两个不同用户连续请求 `/user-info`，断言响应不互串；同用户重复请求命中缓存。
- **实施风险**：中（涉及缓存策略变化与线上行为改变）。

### 2) API 日志落库可能包含明文密码 / Token / 敏感响应
- **影响**：`password`、`access_token`、`refresh_token` 等敏感数据进入数据库日志表，属于高危合规与安全问题；一旦日志表泄露即全量账号风险。
- **证据**
  - 请求体直接 `await request.json()` 并写入 `APILog.request_data`：[middlewares.py](file:///Users/galen/Project/feely-admin/app/core/middlewares.py#L140-L181)
  - 响应体被解析后写入 `APILog.response_data`：[middlewares.py](file:///Users/galen/Project/feely-admin/app/core/middlewares.py#L189-L227)
  - 登录/刷新接口会返回 token：[auth.py](file:///Users/galen/Project/feely-admin/app/api/v1/auth/auth.py#L22-L92)
- **优化建议**
  - **最小化采集**：对敏感路径（`/api/v1/auth/login`、`/api/v1/auth/refresh-token` 等）禁止记录 request/response body。
  - **字段级脱敏**：
    - 对 `password/token/refreshToken/authorization/cookie` 等字段做递归脱敏（`***`）
    - 响应日志仅记录 `code/msg/x-request-id/耗时/响应大小` 等必要元信息
  - **容量保护**：对 request/response body 限制最大记录字节数（例如 8KB 或 32KB），超出只记录摘要与长度。
- **实施风险**：低到中（中间件改动，但对业务响应无影响）。

### 3) 生产启动流程自动生成迁移并升级数据库（高风险）
- **影响**：应用启动时执行 `migrate()/upgrade()` 属于不可控“自动改库”，在生产环境可能锁表、造成不可预期 schema 变化或数据风险。
- **证据**
  - 启动时执行 `modify_db()`：[lifespan](file:///Users/galen/Project/feely-admin/app/__init__.py#L34-L61)
  - `modify_db()` 内部执行 `migrate()` + `upgrade()`：[init_app.py](file:///Users/galen/Project/feely-admin/app/core/init_app.py#L75-L105)
- **优化建议**
  - 将迁移执行从应用启动剥离：由 CI/CD 或运维命令显式执行
  - 应用启动仅保留：数据库连通性检查、只读初始化（必要时）
  - 若必须保留：至少按环境开关（仅 development/testing 可自动迁移）
- **实施风险**：中（涉及部署流程调整）。

### 4) 默认配置包含弱密钥/公网 DB 地址/空密码倾向，易被误用
- **影响**：开发/测试环境容易被复制粘贴到生产；弱密钥导致 JWT 可被伪造；公网 DB 目标与空密码是典型踩坑点。
- **证据**：[settings.toml](file:///Users/galen/Project/feely-admin/app/settings/settings.toml#L19-L59)
- **优化建议**
  - `default` 环境不要提供可运行的弱密钥与公网地址；改为占位并强制校验
  - `production` 启动时做配置校验：检测 `SECRET_KEY` 是否默认值/长度不足，检测 DB 密码是否为空
- **实施风险**：低（只改配置与启动校验）。

---

## P1（High）

### 1) Redis 不可用会导致应用启动失败（可用性问题）
- **影响**：`_init_cache()` 失败直接 `raise`，Redis 一旦不可用会让 API 整体不可用。
- **证据**：[__init__.py:_init_cache](file:///Users/galen/Project/feely-admin/app/__init__.py#L160-L191)
- **优化建议**
  - 将缓存初始化改为“可选能力”：失败降级，不阻断应用启动
  - 统一使用一个缓存体系（FastAPICache vs `cache_manager`），避免重复连接与逻辑分裂

### 2) 菜单/路由树构建存在 N+1 查询与 O(N²) 递归 IO
- **影响**：用户路由接口在多菜单、多角色下会显著变慢，数据库压力骤增。
- **证据**
  - 每个节点都 `await menu.fetch_related("active_menu")`：[build_route_tree](file:///Users/galen/Project/feely-admin/app/api/v1/route/route.py#L14-L59)
  - `user-routes` 内部多处循环 await（角色首页查询、角色菜单加载、父级回溯）：
    - [route.py:user-routes](file:///Users/galen/Project/feely-admin/app/api/v1/route/route.py#L92-L139)
- **优化建议**
  - 一次性 `prefetch_related("active_menu")` 后再构树，避免递归 I/O
  - 内存构树：先按 `parent_id` 分桶，再迭代/递归生成树
  - 角色首页：避免每个角色 `await user_role.by_role_home.first()`，改为一次性预取或按规则确定优先级

### 3) 用户信息接口存在隐性 N+1（按钮权限）
- **影响**：非超级管理员时，按钮权限计算会对每个角色单独 await 查询按钮列表。
- **证据**：[auth.py:user-info](file:///Users/galen/Project/feely-admin/app/api/v1/auth/auth.py#L87-L118)
- **优化建议**
  - 预取：`user.by_user_roles__by_role_buttons`
  - 聚合：在 DB 层按 role_ids 一次性查 buttons（或用中间表 join）

### 4) Redis 清理缓存使用 `KEYS`，可能阻塞 Redis
- **影响**：key 数量上来后，`KEYS` 会阻塞 Redis，影响全局响应。
- **证据**：[cache.py:clear_cache](file:///Users/galen/Project/feely-admin/app/core/cache.py#L186-L207)
- **优化建议**
  - 改用 `SCAN` 分批删除
  - 或使用“前缀版本号”实现逻辑清空（变更 prefix version）

### 5) API 响应日志写入方式性能差且缺少限流/裁剪
- **影响**：每个请求为了更新 response_data 额外 `APILog.get()` 再 `save()`，并解析完整 body；大响应时 CPU/IO 压力明显。
- **证据**：[middlewares.py:_update_response_log](file:///Users/galen/Project/feely-admin/app/core/middlewares.py#L189-L227)
- **优化建议**
  - 使用 `APILog.filter(id=...).update(...)` 直接更新（减少一次读）
  - 仅记录必要字段 + body 大小阈值裁剪
  - 结合 P0 的敏感路径禁记策略

### 6) CORS 配置偏宽，建议生产收敛
- **影响**：`allow_credentials=true` 且 `allow_headers=["*"]` 增加审计复杂度与潜在风险。
- **证据**：[settings.toml:CORS](file:///Users/galen/Project/feely-admin/app/settings/settings.toml#L25-L43)
- **优化建议**
  - 明确列出允许 headers（如 `Authorization, Content-Type, X-Request-Id` 等）
  - 生产环境 origins 强收敛，配置校验阻止 `*`

---

## P2（Medium）

### 1) OAuth2PasswordBearer 的 tokenUrl 与实际登录路由不一致（文档/工具链问题）
- **影响**：Swagger “Authorize” 流程不正确，影响调试与 SDK 生成。
- **证据**
  - [dependency.py:oauth2_schema](file:///Users/galen/Project/feely-admin/app/core/dependency.py#L15-L17)
  - [auth.py:login](file:///Users/galen/Project/feely-admin/app/api/v1/auth/auth.py#L22-L44)
- **优化建议**：将 `tokenUrl` 指向真实登录地址（与 `/api` 前缀一致）。

### 2) 业务异常统一返回 HTTP 200，影响网关/监控语义
- **影响**：401/403/422/500 语义丢失，告警与重试策略难以落地。
- **证据**：[exceptions.py:HttpExcHandle](file:///Users/galen/Project/feely-admin/app/core/exceptions.py#L59-L86)
- **优化建议**：保持 envelope（code/msg）不变的前提下，返回正确的 HTTP status（至少区分认证/鉴权/参数/系统错误）。

### 3) 种子数据包含硬编码弱密码与 print 输出
- **影响**：初始化账号易被误用；`print` 绕过统一日志与追踪。
- **证据**：[initial_data.py](file:///Users/galen/Project/feely-admin/app/db/seeds/initial_data.py#L912-L1037)
- **优化建议**
  - 仅在 development 执行 seed，或要求显式开关
  - 默认密码改为随机生成并输出到安全通道（或要求首次登录修改）
  - `print` 改为统一日志组件

### 4) 日志体系不一致（loguru / 自定义 log / print 混用）
- **影响**：日志格式与链路追踪不统一，排障成本升高。
- **证据**
  - [middlewares.py](file:///Users/galen/Project/feely-admin/app/core/middlewares.py)（`print`）
  - [cache.py](file:///Users/galen/Project/feely-admin/app/core/cache.py)（`loguru.logger`）
- **优化建议**：统一到项目的日志封装（[log.py](file:///Users/galen/Project/feely-admin/app/log/log.py)），并保证每条日志携带 `x-request-id`。

---

## 建议落地顺序（从高到低）
1. P0-1（用户态缓存隔离/禁用）与 P0-2（日志脱敏与禁记）
2. P0-3（生产迁移从启动流程剥离）
3. P0-4（配置强校验：SECRET_KEY/DB 密码等）
4. P1-2/P1-3（路由树与 user-info 的查询优化）
5. P1-4/P1-5（Redis KEYS 改造与日志写入降本）
6. P2（文档语义、HTTP 状态码、seed 改造、日志体系统一）

